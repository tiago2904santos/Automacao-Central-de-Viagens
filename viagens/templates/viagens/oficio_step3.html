{% extends "viagens/base.html" %}
{% load static %}

{% block title %}Novo oficio - Etapa 3{% endblock %}

{% block breadcrumb %}
  Oficios <span class="breadcrumb-sep">/</span> Roteiro
{% endblock %}

{% block content %}
  <nav class="stepper" aria-label="Etapas">
    <a class="stepper-step is-done" href="{% url 'formulario' %}?resume=1" data-step="1" data-step-mode="link">
      <span class="stepper-index">1</span>
      Dados
    </a>
    <a class="stepper-step is-done" href="{% url 'oficio_step2' %}" data-step="2" data-step-mode="link">
      <span class="stepper-index">2</span>
      Transporte
    </a>
    <button class="stepper-step is-active" type="button" data-step="3" disabled>
      <span class="stepper-index">3</span>
      Roteiro
    </button>
  </nav>

  <div class="page-header">
    <div>
      <h2 class="page-title">Etapa 3 - Roteiro e destino</h2>
      <p class="page-subtitle">Defina sede, destinos e datas/horas por trecho.</p>
    </div>
    <div class="page-actions">
      <button class="btn-clear btn-small" type="button" id="addTrechoBtn">Adicionar trecho</button>
    </div>
  </div>

  <div class="card">
    <form method="post" id="roteiroForm" data-formset-prefix="trechos" data-servidores-count="{{ quantidade_servidores|default:0 }}">
      {% csrf_token %}
      {% if erro %}
        <div class="error">{{ erro }}</div>
      {% endif %}
      {% if formset.non_form_errors %}
        <div class="error">{{ formset.non_form_errors }}</div>
      {% endif %}

      {{ formset.management_form }}

      <div class="trecho-list" id="trechosList" data-trechos-list>
        {% for form in formset %}
          <div class="trecho-card{% if forloop.first %} is-first{% endif %}" data-index="{{ forloop.counter0 }}">
            <div class="trecho-header">
              <div>
                <span class="badge">Trecho {{ forloop.counter }}{% if forloop.first %} (Ida){% endif %}</span>
                <div class="trecho-subtitle">Origem e destino do deslocamento.</div>
              </div>
              <button class="btn-link trecho-remove" type="button" data-action="remove" {% if forloop.first %}disabled aria-disabled="true"{% endif %}>
                Remover
              </button>
            </div>

            {% if form.non_field_errors %}
              <div class="field-errors">{{ form.non_field_errors }}</div>
            {% endif %}

            {{ form.id }}

            <div class="trecho-body">
              <div class="sub-card">
                <div class="sub-card-title">Origem{% if forloop.first %} (Sede){% endif %}</div>
                <div class="grid">
                  <label>
                    UF
                    {{ form.origem_estado }}
                    {{ form.origem_estado.errors }}
                    <span class="field-help" data-first-only>Selecione o estado-sede do roteiro.</span>
                  </label>
                  <label>
                    Cidade
                    {{ form.origem_cidade }}
                    {{ form.origem_cidade.errors }}
                    <span class="field-help" data-first-only>Defina a cidade sede.</span>
                  </label>
                  <label>
                    Saida (data)
                    {{ form.saida_data }}
                    {{ form.saida_data.errors }}
                  </label>
                  <label>
                    Saida (hora)
                    {{ form.saida_hora }}
                    {{ form.saida_hora.errors }}
                  </label>
                </div>
              </div>

              <div class="sub-card">
                <div class="sub-card-title">Destino</div>
                <div class="grid">
                  <label>
                    UF
                    {{ form.destino_estado }}
                    {{ form.destino_estado.errors }}
                  </label>
                  <label>
                    Cidade
                    {{ form.destino_cidade }}
                    {{ form.destino_cidade.errors }}
                  </label>
                  <label>
                    Chegada (data)
                    {{ form.chegada_data }}
                    {{ form.chegada_data.errors }}
                  </label>
                  <label>
                    Chegada (hora)
                    {{ form.chegada_hora }}
                    {{ form.chegada_hora.errors }}
                  </label>
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>

      <template id="trechoTemplate">
        <div class="trecho-card" data-index="__prefix__">
          <div class="trecho-header">
            <div>
              <span class="badge">Trecho</span>
              <div class="trecho-subtitle">Origem e destino do deslocamento.</div>
            </div>
            <button class="btn-link trecho-remove" type="button" data-action="remove">Remover</button>
          </div>

          {{ formset.empty_form.id }}

          <div class="trecho-body">
            <div class="sub-card">
              <div class="sub-card-title">Origem</div>
              <div class="grid">
                <label>
                  UF
                  {{ formset.empty_form.origem_estado }}
                </label>
                <label>
                  Cidade
                  {{ formset.empty_form.origem_cidade }}
                </label>
                <label>
                  Saida (data)
                  {{ formset.empty_form.saida_data }}
                </label>
                <label>
                  Saida (hora)
                  {{ formset.empty_form.saida_hora }}
                </label>
              </div>
            </div>

            <div class="sub-card">
              <div class="sub-card-title">Destino</div>
              <div class="grid">
                <label>
                  UF
                  {{ formset.empty_form.destino_estado }}
                </label>
                <label>
                  Cidade
                  {{ formset.empty_form.destino_cidade }}
                </label>
                <label>
                  Chegada (data)
                  {{ formset.empty_form.chegada_data }}
                </label>
                <label>
                  Chegada (hora)
                  {{ formset.empty_form.chegada_hora }}
                </label>
              </div>
            </div>
          </div>
        </div>
      </template>

      <div class="trecho-card" data-retorno-card>
        <div class="trecho-header">
          <div>
            <span class="badge">Retorno</span>
            <div class="trecho-subtitle">Trecho unico de volta para a sede.</div>
          </div>
        </div>

        <div class="trecho-body">
          <div class="sub-card">
            <div class="sub-card-title">Origem</div>
            <div class="grid">
              <label>
                Cidade
                <input type="text" name="retorno_saida_cidade" id="retornoSaidaCidade" value="{{ retorno_saida_cidade|default:'' }}" readonly />
              </label>
              <label>
                Saida (data)
                <input type="date" name="retorno_saida_data" id="retornoSaidaData" value="{{ retorno_saida_data|default:'' }}" />
              </label>
              <label>
                Saida (hora)
                <input type="time" name="retorno_saida_hora" id="retornoSaidaHora" value="{{ retorno_saida_hora|default:'' }}" />
              </label>
            </div>
          </div>

          <div class="sub-card">
            <div class="sub-card-title">Destino (Sede)</div>
            <div class="grid">
              <label>
                Cidade
                <input type="text" name="retorno_chegada_cidade" id="retornoChegadaCidade" value="{{ retorno_chegada_cidade|default:'' }}" readonly />
              </label>
              <label>
                Chegada (data)
                <input type="date" name="retorno_chegada_data" id="retornoChegadaData" value="{{ retorno_chegada_data|default:'' }}" />
              </label>
              <label>
                Chegada (hora)
                <input type="time" name="retorno_chegada_hora" id="retornoChegadaHora" value="{{ retorno_chegada_hora|default:'' }}" />
              </label>
            </div>
          </div>
        </div>
      </div>

      <div class="trecho-card" data-diarias-card>
        <div class="trecho-header">
          <div>
            <span class="badge">Diarias</span>
            <div class="trecho-subtitle">Calculo automatico conforme tipo de destino.</div>
          </div>
        </div>

        <div class="trecho-body">
          <div class="sub-card">
            <div class="grid">
              <label>
                Tipo de destino
                <select name="tipo_destino" id="tipoDestino" required>
                  <option value="">Selecione</option>
                  <option value="INTERIOR" {% if tipo_destino == 'INTERIOR' %}selected{% endif %}>Interior</option>
                  <option value="CAPITAL" {% if tipo_destino == 'CAPITAL' %}selected{% endif %}>Capital</option>
                  <option value="BRASILIA" {% if tipo_destino == 'BRASILIA' %}selected{% endif %}>Brasilia</option>
                </select>
              </label>
              <label>
                Quantidade de diarias
                <input type="text" name="quantidade_diarias" id="quantidadeDiarias" readonly />
                <span class="field-help">Gerado automaticamente.</span>
              </label>
              <label>
                Valor total das diarias
                <input type="text" name="valor_diarias" id="valorDiarias" readonly />
                <span class="field-help">Considera a quantidade de servidores.</span>
              </label>
              <label class="full">
                Valor por extenso (manual)
                <input type="text" name="valor_diarias_extenso" id="valorDiariasExtenso" value="{{ valor_diarias_extenso|default:'' }}" />
                <span class="field-help">Preencha manualmente ate termos conversor automatico.</span>
              </label>
            </div>
          </div>
        </div>
      </div>

      <div class="trecho-card" data-diarias-preview>
        <div class="trecho-header">
          <div>
            <span class="badge">Diarias (previa)</span>
            <div class="trecho-subtitle">Atualiza automaticamente ao preencher os dados.</div>
          </div>
        </div>
        <div class="trecho-body">
          <div class="sub-card">
            <div class="grid">
              <label>
                Resultado
                <div class="preview" id="diariasPreviewText">Preencha sa√≠da/chegada para calcular</div>
              </label>
              <label>
                Valor por servidor
                <div class="preview" id="diariasPreviewPorServidor">-</div>
              </label>
              <label>
                Valor total
                <div class="preview" id="diariasPreviewTotal">-</div>
              </label>
              <label>
                Total de horas
                <div class="preview" id="diariasPreviewHoras">-</div>
              </label>
            </div>
          </div>
        </div>
      </div>

      <section class="grid">
        <label class="full">
          Motivo da viagem
          <textarea name="motivo" rows="3" placeholder="Descreva o motivo">{{ motivo }}</textarea>
          <span class="field-help">Informe o objetivo institucional da viagem.</span>
        </label>
      </section>

      <div class="wizard-actions">
        <a class="btn-clear" href="{% url 'oficio_step2' %}">Voltar</a>
        <button class="btn-primary" type="submit">Finalizar</button>
      </div>
    </form>
  </div>
{% endblock %}

{% block scripts %}
  <script src="{% static 'viagens/oficio_wizard.js' %}"></script>
{% endblock %}
