{% extends "viagens/base.html" %}
{% load static %}

{% block title %}Novo oficio - Etapa 1{% endblock %}

{% block breadcrumb %}
  Oficios <span class="breadcrumb-sep">/</span> Dados
{% endblock %}

{% block content %}
  <nav class="stepper" aria-label="Etapas" data-stepper-form="oficioStep1Form">
    <button class="stepper-step is-active" type="button" data-step="1" disabled>
      <span class="stepper-index">1</span>
      Dados
    </button>
    <button class="stepper-step" type="button" data-step="2">
      <span class="stepper-index">2</span>
      Transporte
    </button>
    <button class="stepper-step" type="button" data-step="3">
      <span class="stepper-index">3</span>
      Roteiro
    </button>
    <button class="stepper-step" type="button" data-step="4">
      <span class="stepper-index">4</span>
      Resumo
    </button>
  </nav>

  <div class="page-header">
    <div>
      <h2 class="page-title">Etapa 1 - Dados do oficio</h2>
      <p class="page-subtitle">Preencha numero do oficio, protocolo e selecione os viajantes.</p>
    </div>
    <div class="page-actions">
      <span class="{{ status_class }}">Status: {{ status_label }}</span>
    </div>
  </div>

  <div class="page-grid page-grid--preview">
    <div class="card">
      <form method="post" id="oficioStep1Form">
        {% csrf_token %}
        {% if erro %}
          <div class="error">{{ erro }}</div>
        {% endif %}

        <section class="grid">
          <label>
            Oficio
            <input type="text" name="oficio" value="{{ oficio }}" data-preview-target="oficio" />
            <span class="field-help">Use o numero oficial do documento.</span>
          </label>
          <label>
            Protocolo
            <input type="text" name="protocolo" value="{{ protocolo }}" data-preview-target="protocolo" />
            <span class="field-help">Informe o protocolo interno.</span>
          </label>
          <label>
            Data de criacao
            <input type="text" value="{{ data_criacao|default:'Automatica apos salvar' }}" readonly />
            <span class="field-help">Definida automaticamente ao salvar o oficio.</span>
          </label>
          <label class="full">
            Motivo da viagem
            <textarea name="motivo" rows="3" data-preview-target="motivo">{{ motivo }}</textarea>
            <span class="field-help">Descreva o motivo da viagem.</span>
          </label>
        </section>

        <section class="sub-card" data-custos-group>
          <div class="sub-card-title">Custos</div>
          <div class="custos-options">
            <select
              name="custeio_tipo"
              class="input-field"
              data-custos-select
            >
              {% for value, label in custeio_tipo_choices %}
                <option value="{{ value }}" {% if value == custeio_tipo %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
          </div>
          <label class="full custos-instituicao{% if custeio_tipo != 'OUTRA_INSTITUICAO' %} is-hidden{% endif %}" data-custos-field>
            Nome da instituição de custeio
            <input
              type="text"
              name="nome_instituicao_custeio"
              value="{{ nome_instituicao_custeio|default:'' }}"
              data-custos-instituicao
              {% if custeio_tipo != 'OUTRA_INSTITUICAO' %}disabled{% endif %}
            />
            <span class="field-help">Obrigatório quando outra instituição for selecionada.</span>
          </label>
        </section>

        <section class="grid">
          <div class="full">
            <div class="field-label">Buscar viajante</div>
            <div class="field-row">
              {{ servidores_form.servidores }}
            </div>
            <div class="field-actions">
              <button
                class="btn-clear btn-small"
                type="button"
                data-modal-url="{% url 'modal_viajante_form' %}"
                data-modal-kind="viajante"
                data-target-select="#servidoresSelect"
              >
                Cadastrar viajante
              </button>
            </div>
            <span class="field-help">Use o campo para localizar por nome, RG ou CPF.</span>
          </div>
          <div class="full">
            <div class="field-label">Viajantes (selecione mais de um)</div>
            <div class="chip-list" id="viajantesList" data-preview-list="viajantes">
              {% for viajante in selected_viajantes %}
                <span class="chip" data-id="{{ viajante.id }}">
                  {{ viajante.nome }}
                  <button type="button" class="chip-remove" data-remove-id="{{ viajante.id }}" aria-label="Remover">
                    &times;
                  </button>
                </span>
              {% endfor %}
            </div>
          </div>
        </section>

        <div class="wizard-actions">
          <a class="btn-clear" href="{% url 'dashboard_home' %}">Voltar</a>
          <button class="btn-primary" type="submit">Avancar</button>
        </div>
      </form>
    </div>

    <aside class="preview-card" aria-live="polite">
      <h3>Relatorio rapido</h3>
      <div class="preview-doc">
        <div class="preview-line">
          <span class="preview-label">Oficio</span>
          <span class="preview-value" data-preview-field="oficio">{{ oficio|default:"-" }}</span>
        </div>
        <div class="preview-line">
          <span class="preview-label">Protocolo</span>
          <span class="preview-value" data-preview-field="protocolo">{{ protocolo|default:"-" }}</span>
        </div>
        <div class="preview-line">
          <span class="preview-label">Data de criacao</span>
          <span class="preview-value">{{ data_criacao|default:"Automatica apos salvar" }}</span>
        </div>
        <div class="preview-line">
          <span class="preview-label">Motivo</span>
          <span class="preview-value" data-preview-field="motivo">{{ motivo|default:"-" }}</span>
        </div>
        <div class="preview-line">
          <span class="preview-label">Custos</span>
          <span class="preview-value" data-preview-field="custos">-</span>
        </div>
      </div>
      <div class="preview-doc">
        <div class="preview-line">
          <span class="preview-label">Servidores</span>
          <span class="preview-value" data-preview-field="viajantes-count">0</span>
        </div>
        <div data-preview-field="viajantes" class="empty">Nenhum servidor selecionado.</div>
      </div>
    </aside>
  </div>
{% endblock %}

{% block scripts %}
  <script src="{% static 'viagens/form.js' %}"></script>
{% endblock %}
