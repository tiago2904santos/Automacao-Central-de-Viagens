{% extends "viagens/base.html" %}

{% block title %}Justificativa{% endblock %}

{% block breadcrumb %}
  Justificativas <span class="breadcrumb-sep">/</span> Oficio
{% endblock %}

{% block content %}
  <div class="page-header">
    <div>
      <h2 class="page-title">JUSTIFICATIVA</h2>
      <p class="page-subtitle">Oficio {{ oficio_display }}.</p>
    </div>
  </div>

  <div class="card">
    {% if requires_justificativa %}
      <div class="error">
        <p>Preencha a justificativa para oficios com antecedencia inferior a 10 dias.</p>
      </div>
    {% endif %}

    <form method="post">
      {% csrf_token %}
      <input type="hidden" name="next" value="{{ next_url }}" />

      <section class="sub-card">
        <div class="sub-card-title">Modelo sugerido</div>
        <div class="grid">
          <label>
            Modelo
            {{ form.justificativa_modelo }}
            {% if form.justificativa_modelo.errors %}
              <span class="error">{{ form.justificativa_modelo.errors|join:", " }}</span>
            {% endif %}
          </label>
          <label style="align-self: end;">
            <button class="btn-clear" type="button" id="aplicarModeloBtn">
              Aplicar modelo
            </button>
          </label>
        </div>
      </section>

      <section class="sub-card">
        <div class="sub-card-title">Texto da justificativa</div>
        <label>
          JUSTIFICATIVA
          {{ form.justificativa_texto }}
          {% if form.justificativa_texto.errors %}
            <span class="error">{{ form.justificativa_texto.errors|join:", " }}</span>
          {% endif %}
        </label>
      </section>

      <div class="wizard-actions">
        <a class="btn-clear" href="{{ next_url }}">Voltar</a>
        <button class="btn-primary" type="submit">Salvar</button>
      </div>
    </form>
  </div>
{% endblock %}

{% block scripts %}
  <script>
    (() => {
      const templates = {{ justificativa_templates_json|safe }};
      const selectEl = document.getElementById("id_justificativa_modelo");
      const textEl = document.getElementById("id_justificativa_texto");
      const applyBtn = document.getElementById("aplicarModeloBtn");

      if (!selectEl || !textEl || !applyBtn) {
        return;
      }

      function getTemplateText() {
        const selectedKey = selectEl.value;
        if (!selectedKey || !templates[selectedKey]) {
          return "";
        }
        return templates[selectedKey].texto || "";
      }

      function applyTemplate() {
        const templateText = getTemplateText();
        if (!templateText) {
          return;
        }
        const currentText = (textEl.value || "").trim();
        if (currentText && currentText !== templateText.trim()) {
          const confirmed = window.confirm(
            "A aplicacao do modelo vai substituir o texto atual. Deseja continuar?"
          );
          if (!confirmed) {
            return;
          }
        }
        textEl.value = templateText;
      }

      applyBtn.addEventListener("click", applyTemplate);
      selectEl.addEventListener("change", () => {
        if (!(textEl.value || "").trim()) {
          applyTemplate();
        }
      });
    })();
  </script>
{% endblock %}
